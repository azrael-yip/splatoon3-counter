<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splatoon 3 æ‰“å·¥çµ±è¨ˆ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root { --bg: #2b2b2b; --card: #3d3d3d; --text: #ecf0f1; --accent: #ff9f43; --green: #1dd1a1; --blue: #3498db; --red: #ff6b6b; --switch-off: #555; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; user-select: none; }
        
        .controls { 
            position: sticky; top: 0; z-index: 100; background: var(--bg); padding: 15px; 
            width: 100%; max-width: 1200px; display: flex; flex-direction: column; align-items: center; 
            border-bottom: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-radius: 0 0 15px 15px; 
        }
        
        h1 { color: var(--accent); margin: 5px 0; font-size: 1.6rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .badge { background: linear-gradient(135deg, #0984e3, #74b9ff); color: #fff; padding: 3px 8px; border-radius: 6px; font-size: 0.8rem; vertical-align: middle; margin-left: 8px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        /* === API åŒæ­¥é¢æ¿ (ä¿®æ­£å¾Œ) === */
        .api-panel {
            background: rgba(52, 152, 219, 0.1); border: 1px solid var(--blue);
            padding: 15px; border-radius: 12px; margin: 10px 0; width: 80%; max-width: 600px;
            display: flex; flex-direction: column; gap: 10px; align-items: center;
        }
        .api-row { display: flex; gap: 10px; width: 100%; justify-content: center; align-items: center; flex-wrap: wrap; }
        .api-input {
            padding: 8px 12px; border-radius: 6px; border: 1px solid #555; 
            background: #222; color: var(--accent); outline: none; flex: 1; text-align: center;
            font-family: monospace; letter-spacing: 1px; min-width: 150px;
        }
        .api-input:focus { border-color: var(--accent); }
        
        .btn-sync {
            background: linear-gradient(135deg, #0984e3, #00cec9); color: white; border: none;
            padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.1s, opacity 0.2s;
            display: flex; align-items: center; gap: 5px; white-space: nowrap;
        }
        .btn-sync:active { transform: scale(0.96); }
        .btn-sync:disabled { opacity: 0.5; cursor: not-allowed; }

        .status-panel {
            background: rgba(29, 209, 161, 0.05); border: 1px solid var(--green);
            padding: 8px 20px; border-radius: 8px; margin: 5px 0 10px; text-align: center; width: 80%; max-width: 600px;
        }
        .status-title { color: var(--green); font-weight: bold; font-size: 1rem; margin-bottom: 2px; }
        .status-detail { color: #aaa; font-size: 0.85rem; }
        
        .drop-zone { 
            background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin: 5px 0; 
            border: 2px dashed #666; cursor: pointer; width: 80%; max-width: 600px; text-align: center; 
            transition: all 0.3s ease; font-size: 0.85rem; color: #888;
        }
        .drop-zone:hover { background: rgba(255, 255, 255, 0.1); border-color: #aaa; }
        
        .filters { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 10px 0 15px; width: 100%; }
        .filter-btn { background: #444; color: #ccc; padding: 6px 14px; border-radius: 20px; border: 1px solid #555; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .filter-btn.active { background: var(--accent); color: #222; font-weight: bold; border-color: var(--accent); box-shadow: 0 0 8px var(--accent); }

        .toolbar {
            width: 100%; border-top: 1px solid #444; padding-top: 15px;
            display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;
        }
        .search-input { 
            padding: 8px 15px; border-radius: 20px; border: 1px solid #555; 
            background: #333; color: white; outline: none; width: 180px;
        }

        .toggle-wrapper {
            display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 10px; border-radius: 30px; transition: background 0.3s;
        }
        .toggle-wrapper:hover { background: rgba(255,255,255,0.05); }
        .toggle-label { font-size: 0.9rem; font-weight: bold; color: #aaa; transition: color 0.3s; }
        .toggle-label.active-text { color: var(--green); text-shadow: 0 0 5px rgba(29,209,161,0.5); }
        .toggle-track {
            width: 44px; height: 24px; background-color: var(--switch-off); border-radius: 12px; position: relative;
            transition: background-color 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .toggle-knob {
            width: 20px; height: 20px; background-color: white; border-radius: 50%; position: absolute; top: 2px; left: 2px;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .toggle-wrapper.on .toggle-track { background-color: var(--green); }
        .toggle-wrapper.on .toggle-knob { transform: translateX(20px); }

        .btn-clear { background: var(--red); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; width: 100%; max-width: 1200px; padding-bottom: 50px; margin-top: 20px; }
        .card { background: var(--card); border: 2px solid #576574; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card.active { border-color: var(--green); background: #2f4038; box-shadow: 0 0 10px rgba(29, 209, 161, 0.2); }
        .img-box { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 5px; }
        .card img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); }
        .card .name { font-size: 0.85rem; text-align: center; color: #bdc3c7; height: 2.8em; overflow: hidden; margin: 0 0 4px; line-height: 1.4em; }
        .card .count { font-size: 1.4em; color: var(--green); font-weight: 800; background: rgba(0,0,0,0.4); width: 100%; text-align: center; border-radius: 6px; padding: 2px 0; }
    </style>
</head>
<body>
    <div class="controls">
        <h1>ğŸŸ æ‰“å·¥æ­¦å™¨ç´€éŒ„ </h1>
        
        <div class="api-panel">
            <div style="font-weight:bold; color:var(--blue);">ğŸ”„ Stat.ink ç·šä¸ŠåŒæ­¥</div>
            <div style="font-size:0.85rem; color:#aaa; margin-bottom:8px;">
                è«‹è¼¸å…¥æ‚¨çš„ <b>Stat.ink ID</b>
            </div>
            <div class="api-row">
                <input type="text" id="statInkId" class="api-input" placeholder="æ‚¨çš„ ID (å¿…å¡«)">
                <input type="password" id="apiToken" class="api-input" placeholder="Token (ç§å¯†å¸³è™Ÿæ‰è¦å¡«)" style="width:120px; flex:0.5;">
                <button class="btn-sync" onclick="syncFromApi()" id="btnSync">
                    <span>â˜ï¸ åŒæ­¥</span>
                </button>
            </div>
            <div style="font-size:0.8rem; color:#888;">
                âš ï¸ è‹¥é»æ“Šç„¡åæ‡‰ï¼Œè«‹å˜—è©¦å®‰è£ <b>Allow CORS</b> æ“´å……åŠŸèƒ½æˆ–ä½¿ç”¨ <b>VS Code Live Server</b>ã€‚
            </div>
        </div>

        <div class="status-panel">
            <div id="status-title" class="status-title">ç­‰å¾…è³‡æ–™å°å…¥...</div>
            <div id="status-detail" class="status-detail">è«‹åŒæ­¥æˆ–æ‹–å…¥æª”æ¡ˆ</div>
        </div>
        
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()" id="dropZone">
            ğŸ“‚ æˆ– é»æ“Šæ­¤è™•æ‰‹å‹•æ‹–å…¥ .json / .gz æª”æ¡ˆ
            <input type="file" id="fileInput" accept=".json,.gz" style="display: none" onchange="handleFile(this.files[0])">
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="setFilter('all')">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="setFilter('ç†Šå°')">ç†Šå°</button>
            <button class="filter-btn" onclick="setFilter('å°„å‡»æª')">å°„å‡»æª</button>
            <button class="filter-btn" onclick="setFilter('æ»šç­’')">æ»šç­’/ç”»ç¬”</button>
            <button class="filter-btn" onclick="setFilter('ç‹™å‡»æª')">ç‹™å‡»æª</button>
            <button class="filter-btn" onclick="setFilter('æ³¼æ¡¶')">æ³¼æ¡¶</button>
            <button class="filter-btn" onclick="setFilter('æ—‹è½¬æª')">æ—‹è½¬æª</button>
            <button class="filter-btn" onclick="setFilter('æœºåŠ¨æª')">æœºåŠ¨æª</button>
            <button class="filter-btn" onclick="setFilter('é˜²ç©ºä¼')">é˜²ç©ºä¼</button>
            <button class="filter-btn" onclick="setFilter('çˆ†ç ´æª')">çˆ†ç ´æª</button>
            <button class="filter-btn" onclick="setFilter('çŒé±¼å¼“')">çŒé±¼å¼“</button>
            <button class="filter-btn" onclick="setFilter('åˆ®æ°´åˆ€')">åˆ®æ°´åˆ€</button>
        </div>
        
        <div class="toolbar">
            <input type="text" id="search" class="search-input" placeholder="ğŸ” æœå°‹æ­¦å™¨..." oninput="render()">
            <div class="toggle-wrapper" id="sortWrapper" onclick="toggleSort()">
                <span class="toggle-label" id="labelDefault">é è¨­</span>
                <div class="toggle-track"><div class="toggle-knob"></div></div>
                <span class="toggle-label" id="labelCount">ä½¿ç”¨æ¬¡æ•¸</span>
            </div>
            <button class="btn-clear" onclick="clearData()">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>
        
        <div id="progress" style="margin-top: 10px; color: var(--green); font-weight: bold;"></div>
    </div>

    <div id="grid" class="grid"></div>

<script>
    // === 1. æ­¦å™¨è³‡æ–™åº« ===
    const weaponData = [
        { name: "ç†Šå…ˆç”Ÿå°ç« çˆ†ç ´æª", id: "Blaster_Bear", cat: "ç†Šå°" },
        { name: "ç†Šå…ˆç”Ÿå°ç« é˜²ç©ºå‚˜", id: "Shelter_Bear", cat: "ç†Šå°" },
        { name: "ç†Šå…ˆç”Ÿå°ç« ç‹™æ“Šæ§", id: "Charger_Bear", cat: "ç†Šå°" },
        { name: "ç†Šå…ˆç”Ÿå°ç« æ½‘æ¡¶", id: "Slosher_Bear", cat: "ç†Šå°" },
        { name: "ç†Šå…ˆç”Ÿå°ç« çµé­šå¼“", id: "Stringer_Bear", cat: "ç†Šå°" },
        { name: "ç†Šå…ˆç”Ÿå°ç« åˆ®æ°´åˆ€", id: "Saber_Bear", cat: "ç†Šå°" },
        { name: "ç†Šå…ˆç”Ÿå°ç« æ©Ÿå‹•æ§", id: "Twins_Bear", cat: "ç†Šå°" },
        { name: "ç†Šå…ˆç”Ÿå°ç« æ»¾ç­’", id: "Roller_Bear", cat: "ç†Šå°" },
        { name: "æ–°è‘‰å°„æ“Šæ§", id: "Shooter_First", cat: "å°„å‡»æª" },
        { name: "å°ˆæ¥­æ¨¡å‹æ§MG", id: "Shooter_Blaze", cat: "å°„å‡»æª" },
        { name: "æ–¯æ™®æ‹‰å°„æ“Šæ§", id: "Shooter_Normal", cat: "å°„å‡»æª" },
        { name: ".52åŠ ä¾–", id: "Shooter_Gravity", cat: "å°„å‡»æª" },
        { name: "N-ZAP85", id: "Shooter_QuickMiddle", cat: "å°„å‡»æª" },
        { name: "é ‚å°–å°„æ“Šæ§", id: "Shooter_Expert", cat: "å°„å‡»æª" },
        { name: ".96åŠ ä¾–", id: "Shooter_Heavy", cat: "å°„å‡»æª" },
        { name: "å™´å°„æ¸…æ½”æ§", id: "Shooter_Long", cat: "å°„å‡»æª" },
        { name: "L3å·ç®¡æ§", id: "Shooter_Triple", cat: "å°„å‡»æª" },
        { name: "H3å·ç®¡æ§", id: "Shooter_Flash", cat: "å°„å‡»æª" },
        { name: "é–‹ç“¶å™´æ³‰æ§", id: "Shooter_Bottle", cat: "å°„å‡»æª" },
        { name: "å»£åŸŸæ¨™è¨˜æ§", id: "Shooter_Short", cat: "å°„å‡»æª" },
        { name: "çª„åŸŸæ¨™è¨˜æ§", id: "Shooter_Precision", cat: "å°„å‡»æª" },
        { name: "å¤ªç©ºå°„æ“Šæ§", id: "Shooter_Nova", cat: "å°„å‡»æª" },
        { name: "æ–°æ˜Ÿçˆ†ç ´æ§", id: "Blaster_Short", cat: "çˆ†ç ´æª" },
        { name: "ç«ç†±çˆ†ç ´æ§", id: "Blaster_Middle", cat: "çˆ†ç ´æª" },
        { name: "é è·çˆ†ç ´æ§", id: "Blaster_Long", cat: "çˆ†ç ´æª" },
        { name: "å¿«é€Ÿçˆ†ç ´æ§", id: "Blaster_Precision", cat: "çˆ†ç ´æª" },
        { name: "å¿«é€Ÿçˆ†ç ´æ§ ç²¾è‹±", id: "Blaster_Expert", cat: "çˆ†ç ´æª" },
        { name: "æ²–å¡—çˆ†ç ´æ§", id: "Blaster_Light", cat: "çˆ†ç ´æª" },
        { name: "S-BLAST92", id: "Blaster_ShortLong", cat: "çˆ†ç ´æª" },
        { name: "ç¢³çº–ç¶­æ»¾ç­’", id: "Roller_Compact", cat: "æ»šç­’" },
        { name: "æ–¯æ™®æ‹‰æ»¾ç­’", id: "Roller_Normal", cat: "æ»šç­’" },
        { name: "é›»å‹•é¦¬é”æ»¾ç­’", id: "Roller_Heavy", cat: "æ»šç­’" },
        { name: "å¯è®Šå¼æ»¾ç­’", id: "Roller_Hunter", cat: "æ»šç­’" },
        { name: "å¯¬æ»¾ç­’", id: "Roller_Wide", cat: "æ»šç­’" },
        { name: "å·´å‹ƒç¾…", id: "Brush_Mini", cat: "æ»šç­’" },
        { name: "åŒ—é½‹", id: "Brush_Normal", cat: "æ»šç­’" },
        { name: "æ–‡æ£®", id: "Brush_Heavy", cat: "æ»šç­’" },
        { name: "é­·å¿«æ½”Î±", id: "Charger_Quick", cat: "ç‹™å‡»æª" },
        { name: "æ–¯æ™®æ‹‰è“„åŠ›ç‹™æ“Šæ§", id: "Charger_Normal", cat: "ç‹™å‡»æª" },
        { name: "å…¬å‡4K", id: "Charger_Long", cat: "ç‹™å‡»æª" },
        { name: "14å¼ç«¹ç­’æ§Â·ç”²", id: "Charger_Light", cat: "ç‹™å‡»æª" },
        { name: "æ²¹ç®¡", id: "Charger_Keep", cat: "ç‹™å‡»æª" },
        { name: "R-PEN/5H", id: "Charger_Pencil", cat: "ç‹™å‡»æª" },
        { name: "é£›æ¿ºæ½‘æ¡¶", id: "Slosher_Strong", cat: "æ³¼æ¡¶" },
        { name: "æ´—ç­†æ¡¶", id: "Slosher_Diffusion", cat: "æ³¼æ¡¶" },
        { name: "å›æ—‹æ½‘æ¡¶", id: "Slosher_Launcher", cat: "æ³¼æ¡¶" },
        { name: "æ»¿æº¢æ³¡æ¾¡æ½‘æ¡¶", id: "Slosher_Bathtub", cat: "æ³¼æ¡¶" },
        { name: "çˆ†ç‚¸æ½‘æ¡¶", id: "Slosher_Explosion", cat: "æ³¼æ¡¶" },
        { name: "å¢¨æ½‘æ·‹", id: "Slosher_Washtub", cat: "æ³¼æ¡¶" },
        { name: "æ–¯æ™®æ‹‰æ—‹è½‰æ§", id: "Spinner_Mini", cat: "æ—‹è½¬æª" },
        { name: "æ¡¶è£æ—‹è½‰æ§", id: "Spinner_Standard", cat: "æ—‹è½¬æª" },
        { name: "æ¶ˆé˜²æ “æ—‹è½‰æ§", id: "Spinner_Hyper", cat: "æ—‹è½¬æª" },
        { name: "é¸šéµ¡èºè™Ÿ47", id: "Spinner_Seryu", cat: "æ—‹è½¬æª" },
        { name: "åœ“ç ç­†", id: "Spinner_Down", cat: "æ—‹è½¬æª" },
        { name: "å¯©æŸ¥è€…", id: "Spinner_Duberu", cat: "æ—‹è½¬æª" },
        { name: "æ¿ºéæ§", id: "Twins_Short", cat: "æœºåŠ¨æª" },
        { name: "æ–¯æ™®æ‹‰æ©Ÿå‹•æ§", id: "Twins_Normal", cat: "æœºåŠ¨æª" },
        { name: "é–‹çˆ¾æ–‡525", id: "Twins_Gallon", cat: "æœºåŠ¨æª" },
        { name: "é›™é‡æ¸…æ½”æ§", id: "Twins_Long", cat: "æœºåŠ¨æª" },
        { name: "å››é‡å½ˆè·³æ‰‹æ§", id: "Twins_Hover", cat: "æœºåŠ¨æª" },
        { name: "æ»…ç«å™¨FF", id: "Twins_Dual", cat: "æœºåŠ¨æª" },
        { name: "é®é™½é˜²ç©ºå‚˜", id: "Shelter_Normal", cat: "é˜²ç©ºä¼" },
        { name: "éœ²ç‡Ÿé˜²ç©ºå‚˜", id: "Shelter_Face", cat: "é˜²ç©ºä¼" },
        { name: "ç‰¹å·¥å‚˜", id: "Shelter_Compact", cat: "é˜²ç©ºä¼" },
        { name: "24å¼é˜²ç©ºå‚˜Â·ç”²", id: "Shelter_Wide", cat: "é˜²ç©ºä¼" },
        { name: "ä¸‰ç™¼çµé­šå¼“", id: "Stringer_Normal", cat: "çŒé±¼å¼“" },
        { name: "LACT-450", id: "Stringer_Short", cat: "çŒé±¼å¼“" },
        { name: "é‚¦æ™® V", id: "Stringer_V", cat: "çŒé±¼å¼“" },
        { name: "å·¥ä½œåˆ®æ°´åˆ€", id: "Saber_Heavy", cat: "åˆ®æ°´åˆ€" },  
        { name: "é›¨åˆ·åˆ®æ°´åˆ€", id: "Saber_Normal", cat: "åˆ®æ°´åˆ€" }, 
        { name: "è–„è·ç‰™è†åˆ€", id: "Saber_Lite", cat: "åˆ®æ°´åˆ€" }    
    ];

    const statInkMap = {
        "kuma_blaster": "Blaster_Bear", "kuma_shelter": "Shelter_Bear", "kuma_charger": "Charger_Bear",
        "kuma_slosher": "Slosher_Bear", "kuma_stringer": "Stringer_Bear", "kuma_wiper": "Saber_Bear",
        "kuma_maneuver": "Twins_Bear", "kuma_roller": "Roller_Bear",
        "sshooter": "Shooter_Normal", "sharp": "Shooter_Precision", "bold": "Shooter_Short",
        "96gal": "Shooter_Heavy", "52gal": "Shooter_Gravity", "nzap85": "Shooter_QuickMiddle", 
        "prime": "Shooter_Expert", "jetsweeper": "Shooter_Long", "wakaba": "Shooter_First", 
        "promodeler_mg": "Shooter_Blaze", "spaceshooter": "Shooter_Nova",
        "l3reelgun": "Shooter_Triple", "h3reelgun": "Shooter_Flash", "bottlegeyser": "Shooter_Bottle",
        "furo": "Slosher_Bathtub", "moprin": "Slosher_Washtub", "bucketslosher": "Slosher_Strong",
        "hissen": "Slosher_Diffusion", "screwslosher": "Slosher_Launcher", "explosher": "Slosher_Explosion",
        "soytuber": "Charger_Keep", "splatcharger": "Charger_Normal", "liter4k": "Charger_Long",
        "squiclean_a": "Charger_Quick", "rpen_5h": "Charger_Pencil",
        "quadhopper_black": "Twins_Hover", "sputtery": "Twins_Short", "maneuver": "Twins_Normal",
        "kelvin525": "Twins_Gallon", "dualsweeper": "Twins_Long", "gaen_ff": "Twins_Dual",
        "hydra": "Spinner_Hyper", "splatspinner": "Spinner_Mini", "barrelspinner": "Spinner_Standard",
        "nautilus47": "Spinner_Seryu", "examiner": "Spinner_Duberu", "kugelshreiber": "Spinner_Down",
        "splatroller": "Roller_Normal", "variableroller": "Roller_Hunter", "carbon": "Roller_Compact",
        "dynamo": "Roller_Heavy", "wideroller": "Roller_Wide",
        "nova": "Blaster_Short", "hotblaster": "Blaster_Middle", "longblaster": "Blaster_Long",
        "rapid": "Blaster_Precision", "rapid_elite": "Blaster_Expert", "clash": "Blaster_Light",
        "sblast92": "Blaster_ShortLong",
        "pablo": "Brush_Mini", "hokusai": "Brush_Normal", "fincent": "Brush_Heavy",
        "parashelter": "Shelter_Normal", "campingshelter": "Shelter_Face", "brella24mk1": "Shelter_Wide",
        "spy_gadget": "Shelter_Compact",
        "tristringer": "Stringer_Normal", "lact450": "Stringer_Short",
        "drivewiper": "Saber_Normal", 
        "jimuwiper": "Saber_Heavy",    
        "dentalwiper_mint": "Saber_Lite" 
    };

    // === 2. é‚è¼¯æ§åˆ¶ ===
    let userCounts = {}, processedIds = new Set(), currentFilter = 'all';
    let currentShiftInfo = { from: null, stage: "æœªçŸ¥" };
    let currentSort = 'default';

    window.onload = () => {
        try {
            const storedCounts = sessionStorage.getItem('counts');
            const storedIds = sessionStorage.getItem('ids');
            const storedShift = sessionStorage.getItem('shiftInfo');

            if (storedCounts) userCounts = JSON.parse(storedCounts);
            if (storedIds) processedIds = new Set(JSON.parse(storedIds));
            if (storedShift) currentShiftInfo = JSON.parse(storedShift);
            
            const savedId = localStorage.getItem('statInkId');
            const savedToken = localStorage.getItem('statInkToken');
            
            if(savedId && document.getElementById('statInkId')) document.getElementById('statInkId').value = savedId;
            if(savedToken && document.getElementById('apiToken')) document.getElementById('apiToken').value = savedToken;

            updateStatusPanel();
        } catch(e) { console.warn("Session Init Error:", e); }
        initDropZone();
        updateToggleVisual();
        render();
    };

    // === API åŒæ­¥å‡½æ•¸ ===
    async function syncFromApi() {
        const idInput = document.getElementById('statInkId');
        const tokenInput = document.getElementById('apiToken');
        
        const userId = idInput.value.trim();
        const token = tokenInput.value.trim();
        const btn = document.getElementById('btnSync');
        
        if (!userId) { alert("è«‹è¼¸å…¥æ‚¨çš„ Stat.ink ID (ç¶²å€ @ å¾Œé¢çš„åç¨±)ï¼"); return; }

        localStorage.setItem('statInkId', userId);
        if (token) localStorage.setItem('statInkToken', token);

        btn.disabled = true;
        btn.innerHTML = `<span>â³ è®€å–ä¸­...</span>`;

        try {
            // ä½¿ç”¨ Feed ç¶²å€ï¼Œé€™æ‰æ˜¯æ­£ç¢ºçš„ GET æ–¹å¼
            const url = `https://stat.ink/@${userId}/salmon3.json?limit=50`;
            const headers = { 'Accept': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            const response = await fetch(url, { headers });

            if (!response.ok) {
                if (response.status === 0) throw new Error("ç€è¦½å™¨ CORS é˜»æ“‹ã€‚è«‹ä½¿ç”¨ VS Code Live Server æˆ– Allow CORS å¤–æ›ã€‚");
                if (response.status === 404) throw new Error(`æ‰¾ä¸åˆ°ç”¨æˆ¶ "${userId}" æˆ–è³‡æ–™ä¸å…¬é–‹ã€‚`);
                throw new Error(`API éŒ¯èª¤: ${response.status}`);
            }

            const data = await response.json();
            processRecords(data, "API åŒæ­¥");

        } catch (err) {
            console.error(err);
            alert(`åŒæ­¥å¤±æ•—ï¼š${err.message}\n\nğŸ’¡ æç¤ºï¼šè«‹ç¢ºèª ID æ­£ç¢ºã€‚è‹¥æ˜¯ CORS éŒ¯èª¤ï¼Œè«‹å®‰è£ Allow CORS å¤–æ›æˆ–ä½¿ç”¨æ‹–æ›³æª”æ¡ˆæ–¹å¼ã€‚`);
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<span>â˜ï¸ åŒæ­¥</span>`;
        }
    }

    function updateStatusPanel() {
        const titleEl = document.getElementById('status-title');
        const detailEl = document.getElementById('status-detail');
        if (titleEl && currentShiftInfo.from) {
            titleEl.innerText = `ç›®å‰çµ±è¨ˆå ´æ¬¡: ${currentShiftInfo.from}`;
        }
        if (detailEl && currentShiftInfo.stage) {
            detailEl.innerText = `å ´åœ°: ${currentShiftInfo.stage} | è‡ªå‹•éæ¿¾éæ­¤æ™‚æ®µçš„ç´€éŒ„`;
            titleEl.style.color = "var(--accent)";
        }
    }

    function initDropZone() {
        const dz = document.getElementById('dropZone');
        if (!dz) return;
        dz.ondragover = e => { e.preventDefault(); dz.style.background = 'rgba(52, 152, 219, 0.2)'; };
        dz.ondragleave = () => dz.style.background = 'rgba(255, 255, 255, 0.05)';
        dz.ondrop = e => {
            e.preventDefault();
            dz.style.background = 'rgba(255, 255, 255, 0.05)';
            if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        };
    }

    async function handleFile(file) {
        if(!file) return;
        try {
            const buffer = await file.arrayBuffer();
            let uint8 = new Uint8Array(buffer);
            let content = "";

            if (uint8[0] === 0x1f && uint8[1] === 0x8b) {
                if (typeof pako !== 'undefined') {
                    uint8 = pako.ungzip(uint8);
                } else {
                    const ds = new DecompressionStream('gzip');
                    const stream = new Blob([uint8]).stream().pipeThrough(ds);
                    const res = new Response(stream);
                    uint8 = new Uint8Array(await res.arrayBuffer());
                }
            }
            content = new TextDecoder("utf-8").decode(uint8);
            
            let records = [];
            const lines = content.split(/\r?\n/);
            lines.forEach(line => { if(line.trim()) try { records.push(JSON.parse(line)); } catch(e){} });
            
            if (records.length === 0) {
                const parsed = JSON.parse(content);
                records = Array.isArray(parsed) ? parsed : [parsed];
            }

            processRecords(records, "æª”æ¡ˆå°å…¥");

        } catch (err) {
            console.error(err);
            alert(`æª”æ¡ˆè§£æéŒ¯èª¤: ${err.message}`);
        }
        document.getElementById('fileInput').value = '';
    }

    // === æ ¸å¿ƒè³‡æ–™è™•ç† ===
    function processRecords(records, sourceName) {
        records.sort((a, b) => (b.start_at?.time || 0) - (a.start_at?.time || 0));
        
        if (records.length === 0) { alert("æ²’æœ‰æ‰¾åˆ°æ‰“å·¥ç´€éŒ„"); return; }

        const latestRecord = records[0];
        const latestShiftFrom = latestRecord.shift?.from;
        
        if (latestShiftFrom) {
            const stageName = latestRecord.stage?.name?.zh_TW || latestRecord.stage?.name?.ja_JP || latestRecord.stage?.name?.en_US || "æœªçŸ¥å ´åœ°";
            
            if (currentShiftInfo.rawFrom && currentShiftInfo.rawFrom !== latestShiftFrom) {
                if(confirm(`æª¢æ¸¬åˆ°æ–°ç­è¡¨ (${stageName})ï¼Œæ˜¯å¦æ¸…ç©ºèˆŠè³‡æ–™ï¼Ÿ`)) {
                    userCounts = {}; processedIds = new Set();
                }
            }

            currentShiftInfo = { 
                from: new Date(latestShiftFrom).toLocaleString(), 
                stage: stageName, 
                rawFrom: latestShiftFrom 
            };
            sessionStorage.setItem('shiftInfo', JSON.stringify(currentShiftInfo));
            updateStatusPanel();

            records = records.filter(r => r.shift?.from === latestShiftFrom);
        }

        let added = 0;
        records.forEach(rec => {
            const uid = rec.uuid || rec.id;
            if(!uid || processedIds.has(uid)) return;
            processedIds.add(uid);
            added++;

            const me = rec.players?.find(p => p.me) || rec.player;
            const weapons = me?.weapons || (me?.weapon ? [me.weapon] : []);

            weapons.forEach(w => {
                let ref = null;
                if (w.key && statInkMap[w.key]) ref = weaponData.find(d => d.id === statInkMap[w.key]);
                if (!ref && w.key) ref = weaponData.find(d => d.id === w.key);
                if(ref) userCounts[ref.name] = (userCounts[ref.name] || 0) + 1;
            });
        });

        save();
        render();
        alert(`âœ… ${sourceName} æˆåŠŸï¼\né–å®šç­è¡¨ï¼š${currentShiftInfo.from}\næœ¬æ¬¡æ–°å¢ï¼š${added} å ´`);
    }

    function toggleSort() {
        currentSort = currentSort === 'default' ? 'count' : 'default';
        updateToggleVisual();
        render();
    }

    function updateToggleVisual() {
        const wrapper = document.getElementById('sortWrapper');
        const lblDefault = document.getElementById('labelDefault');
        const lblCount = document.getElementById('labelCount');
        if (currentSort === 'count') {
            wrapper.classList.add('on');
            lblCount.classList.add('active-text');
            lblDefault.classList.remove('active-text');
        } else {
            wrapper.classList.remove('on');
            lblDefault.classList.add('active-text');
            lblCount.classList.remove('active-text');
        }
    }

    function render() {
        const grid = document.getElementById('grid');
        const term = document.getElementById('search').value.toLowerCase();
        grid.innerHTML = '';

        const unique = [];
        const seen = new Set();
        weaponData.forEach(w => { if(!seen.has(w.id)) { seen.add(w.id); unique.push(w); }});

        let list = unique.filter(w => {
            const hitName = w.name.toLowerCase().includes(term);
            const hitCat = currentFilter === 'all' || w.cat === currentFilter;
            return hitName && hitCat;
        });

        if (currentSort === 'count') {
            list.sort((a, b) => {
                const countA = userCounts[a.name] || 0;
                const countB = userCounts[b.name] || 0;
                if (countB !== countA) return countB - countA;
                return weaponData.indexOf(a) - weaponData.indexOf(b);
            });
        }

        list.forEach(w => {
            const num = userCounts[w.name] || 0;
            const div = document.createElement('div');
            div.className = `card ${num > 0 ? 'active' : ''}`;
            
            const localPath = `images/Path_Wst_${w.id}.png`;
            const onlinePath = `https://raw.githubusercontent.com/Leanny/splat3/main/images/weapon_flat/Path_Wst_${w.id}.png`;
            
            div.innerHTML = `
                <div class="img-box">
                    <img src="${localPath}" onerror="this.onerror=null; this.src='${onlinePath}'">
                </div>
                <div class="name">${w.name}</div>
                <div class="count">${num}</div>
            `;
            div.onclick = () => modCount(w.name, 1);
            div.oncontextmenu = e => { e.preventDefault(); modCount(w.name, -1); };
            grid.appendChild(div);
        });
        
        const total = unique.length;
        const has = unique.filter(w => (userCounts[w.name]||0) > 0).length;
        const progressEl = document.getElementById('progress');
        if(progressEl) progressEl.innerText = `æ”¶é›†é€²åº¦: ${has} / ${total} (${Math.round(has/total*100)}%)`;
    }

    function modCount(name, v) {
        userCounts[name] = Math.max(0, (userCounts[name]||0) + v);
        save(); render();
    }
    
    function save() {
        sessionStorage.setItem('counts', JSON.stringify(userCounts));
        sessionStorage.setItem('ids', JSON.stringify([...processedIds]));
    }
    
    function setFilter(c) {
        currentFilter = c;
        document.querySelectorAll('.filter-btn').forEach(b => {
            if (b.classList.contains('sort-btn')) return;
            b.classList.toggle('active', b.innerText.includes(c) || (c==='all' && b.innerText==='å…¨éƒ¨'));
        });
        render();
    }

    function clearData() {
        if(confirm("ç¢ºå®šæ¸…é™¤è³‡æ–™ï¼Ÿ")) {
            userCounts = {}; processedIds = new Set(); currentShiftInfo = { from: null, stage: "æœªçŸ¥" };
            sessionStorage.removeItem('shiftInfo');
            updateStatusPanel();
            save(); render();
        }
    }
</script>
</body>
</html>